#!/usr/bin/env python
# encoding: utf-8

from scrapy.downloadermiddlewares.retry import RetryMiddleware
import logging
import random


logger = logging.getLogger(__name__)
PROXY_PORT = {
        "121.32.52.10": "9999",
        "111.12.117.68": "8080",
        "218.95.81.102": "9000",
        "182.205.140.84": "80",
        "182.205.117.103": "3128",
        "49.93.26.51": "3128",
        "49.94.14.167": "3128",
        "27.46.21.24": "8888",
        "163.125.125.16": "9999",
        "113.125.59.59": "80",
        "113.141.130.10": "3128",
        '1.179.176.37': '8080', '183.111.169.201': '3128', '14.139.172.170': '3128', '181.198.34.241': '8080', '195.40.6.43': '3128', '1.9.110.1': '8080', '109.196.210.110': '8080', '91.98.143.85': '80', '190.63.174.246': '8081', '103.10.22.242': '3128', '190.121.158.114': '8080', '94.100.50.54': '8080', '46.19.231.190': '8080', '94.199.122.171': '3128', '88.135.140.117': '8080', '141.101.225.56': '3128', '180.211.179.50': '8080', '1.186.34.51': '80', '190.3.127.21': '80', '123.136.62.225': '8080', '110.74.182.53': '3128', '201.20.177.27': '8080', '162.208.49.45': '8089', '200.41.61.252': '8080', '187.44.255.1': '8080', '187.120.34.213': '3128', '199.255.95.37': '8080', '31.170.178.42': '8080', '188.168.26.0': '8080', '137.135.166.225': '8125', '31.170.178.41': '8080', '1.255.53.81': '80', '177.43.243.107': '8080', '188.233.176.2': '8080', '177.184.187.134': '8080', '176.36.10.245': '3128', '123.30.75.115': '3128', '1.179.158.26': '3128', '187.44.255.10': '8080', '58.27.246.250': '8080', '115.127.69.2': '8080', '110.5.110.118': '80', '92.50.31.66': '8080', '104.238.83.28': '443', '185.76.33.195': '8080', '89.218.93.59': '3130', '177.136.113.38': '8080', '31.170.178.38': '8080', '186.211.65.59': '80', '200.150.97.30': '8080', '109.201.19.201': '8080', '95.215.183.23': '8080', '210.1.81.46': '8080', '181.211.191.227': '8080', '200.192.253.151': '8080', '178.22.148.122': '3129', '196.41.60.230': '8080', '202.119.25.73': '9999', '190.121.232.75': '8080', '198.11.172.39': '3128', '103.4.167.230': '8080', '41.72.105.38': '3128', '201.249.88.202': '3128', '106.186.22.65': '8888', '202.162.214.116': '3128', '168.63.20.19': '8121', '103.55.36.252': '8080', '190.155.107.190': '8888', '166.62.85.115': '8080', '190.37.140.150': '3128', '202.145.3.242': '8080', '41.60.130.36': '8080', '190.85.130.18': '3128', '193.37.152.186': '3128', '202.154.190.150': '8080', '123.231.229.182': '3128', '14.139.236.210': '8080', '31.170.179.35': '8080', '87.106.162.134': '80', '188.43.10.154': '3128', '186.91.167.101': '8080', '46.225.239.178': '8080', '187.49.81.20': '6006', '112.137.164.232': '3128', '14.63.165.60': '3128', '195.186.81.94': '80', '183.111.169.204': '3128', '195.186.81.92': '80', '183.111.169.207': '3128', '190.221.23.158': '80', '200.41.226.60': '3128', '36.75.163.30': '8080', '202.134.6.227': '9999', '177.223.12.121': '8080', '115.124.75.148': '80', '125.161.171.81': '4480', '139.255.40.130': '8080', '59.8.174.50': '3128', '46.209.63.202': '8080', '203.162.69.22': '3128', '114.6.34.194': '8080', '46.209.70.75': '8080', '38.98.148.57': '8080', '190.208.45.221': '3128', '124.146.151.106': '8080', '188.237.149.78': '8080', '94.200.66.206': '3130', '213.141.149.28': '3128', '201.219.122.50': '8080', '190.202.164.9': '8085', '114.207.216.220': '80', '125.209.108.82': '8080', '213.108.74.236': '8081', '41.78.88.181': '8080', '27.131.173.2': '8080', '176.31.175.43': '80', '202.153.130.214': '80', '213.157.52.75': '3130', '176.110.163.230': '3128', '5.189.140.246': '8118', '80.191.228.38': '8080', '201.199.134.195': '3128', '101.99.18.237': '8080', '62.43.202.124': '8081', '91.243.163.202': '8080', '103.245.197.78': '8080', '191.33.171.138': '8080', '200.46.86.66': '3128', '202.119.25.69': '9999', '177.87.241.94': '8080', '187.111.0.174': '8080', '110.78.167.94': '8080', '193.193.246.42': '3130', '219.93.183.200': '80', '154.73.65.8': '8080', '200.150.97.27': '8080', '196.40.112.53': '8080', '202.79.59.110': '8080', '118.97.30.114': '8080', '149.156.112.55': '80', '200.87.179.178': '8080', '14.139.235.137': '3128', '111.223.52.2': '80', '181.114.226.160': '8080', '99.185.0.108': '3128', '190.85.155.172': '8080', '78.46.8.204': '80', '118.97.255.106': '8080', '119.252.174.210': '8080', '202.51.102.34': '8080', '201.144.9.102': '8080', '46.36.112.93': '8000', '200.198.212.173': '80', '202.119.25.71': '9999', '27.131.47.132': '8080', '186.46.129.115': '3128', '195.175.201.170': '8080', '31.193.147.10': '8080', '85.15.176.223': '8080', '200.8.105.131': '8080', '195.34.100.6': '8080', '195.186.81.96': '80', '213.136.79.124': '80', '200.49.4.101': '8080', '60.254.32.1': '8080', '86.100.118.44': '80', '47.88.16.68': '3128', '93.91.160.119': '8080', '196.201.231.110': '8080', '46.32.31.118': '8080', '213.24.60.52': '8080', '222.124.176.18': '8080', '146.255.78.254': '8080', '188.39.148.166': '8080', '190.215.48.228': '3128', '178.151.149.227': '80', '197.149.85.198': '8080', '177.67.153.10': '3128', '186.147.230.234': '8080', '72.252.117.246': '8080', '219.93.183.94': '80', '168.1.9.238': '80', '37.57.39.29': '8080', '103.41.120.3': '8080', '64.26.152.44': '80', '37.187.253.39': '8118', '125.140.118.12': '3128', '188.138.195.178': '8080', '80.87.33.134': '8080', '130.94.148.99': '80', '81.29.245.73': '8080', '91.121.153.214': '3128', '129.22.150.159': '3128', '212.91.188.166': '3128', '14.139.214.181': '9797', '178.252.189.226': '3128', '114.109.81.121': '8080', '202.53.254.99': '8080', '118.98.216.86': '8080', '89.218.38.202': '8080', '202.29.97.2': '3128', '186.103.149.50': '8080', '23.102.76.187': '8080', '196.3.96.185': '8080', '103.11.116.46': '80', '94.74.150.19': '8080', '31.170.178.40': '8080', '109.237.13.181': '8080', '168.63.24.174': '8124', '115.124.65.34': '8080', '208.109.249.220': '80', '181.143.9.91': '8080', '80.242.219.50': '3128', '61.75.2.124': '3128', '190.15.192.120': '3128', '187.188.195.66': '8080', '61.19.86.244': '808', '218.49.74.233': '8080', '177.87.241.226': '8080', '109.201.19.194': '8080', '186.67.158.43': '3128', '46.146.226.231': '8080', '36.83.0.113': '3128', '189.45.56.98': '3128', '24.205.244.90': '7004', '175.138.67.66': '8888', '88.255.148.24': '8080', '180.250.3.26': '8080', '202.119.25.72': '9999', '93.51.247.104': '80', '85.194.75.18': '8080', '190.128.238.38': '8080', '45.35.13.208': '3128', '183.107.62.155': '3128', '201.116.227.171': '3128', '186.0.222.10': '8080', '186.227.208.162': '8081', '201.208.38.168': '3128'
            }


class CustomRetryMiddleware(RetryMiddleware):
    def _retry(self, request, reason, spider):
        retries = request.meta.get('retry_times', 0) + 1

        if retries <= self.max_retry_times:
            logger.debug("Retrying %(request)s (failed %(retries)d times):\
                    %(reason)s",
                    {
                        'request': request,
                        'retries': retries,
                        'reason': reason
                        },
                    extra={'spider': spider})
            retryreq = request.copy()
            retryreq.meta['retry_times'] = retries
            retryreq.dont_filter = True
            retryreq.priority = request.priority + self.priority_adjust
            ip = random.choice(PROXY_PORT.keys())
            port = PROXY_PORT[ip]
            retryreq.meta['proxy'] = "http://" + ip + ":" + port
            return retryreq
        else:
            logger.debug("Gave up retrying %(request)s (failed %(retries)d times): %(reason)s",
                    {
                        'request': request,
                        'retries': retries,
                        'reason': reason
                        },
                    extra={'spider': spider})

